#!/bin/bash
set -exu

WD="$(pwd)"
CMD=${*:-}
STAGE="${STAGE:-dev}"
IMAGE_NAME="leihs-legacy-${STAGE}"
IMAGE_WORKDIR="/leihs/legacy"

IMAGE_TAG=
source bin/require-clean-working-tree
LEGACY_SHORT_TREE_ID="$(git log -n1 --format="%t" HEAD)"
LEGACY_COMMIT_ID="$(git log -n1 --format="%H" HEAD)"
tree_tag="${IMAGE_NAME}:tree-${LEGACY_SHORT_TREE_ID}"
commit_tag="${IMAGE_NAME}:commit-${LEGACY_COMMIT_ID}"
if check-clean-working-tree; then
  if docker inspect "$tree_tag" &> /dev/null; then
    IMAGE_TAG="$tree_tag"
  fi
  if docker inspect "$commit_tag" &> /dev/null; then
    IMAGE_TAG="$commit_tag"
  fi
fi
if ! test "${IMAGE_TAG:-}"; then
  IMAGE_TAG="$(STAGE=$STAGE bin/docker-build | tail -1)"
fi

test "$IMAGE_TAG"

  # -v "${WD}/:${IMAGE_WORKDIR}/" \
docker run --rm -it \
  "$IMAGE_TAG" \
  ${CMD}